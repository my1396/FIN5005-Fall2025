---
title: "Data Visualization"
---

::: {.callout-note appearance="simple" icon=false}
**Study Objectives**

- Loads and prepares the California school dataset (CASchools) for analysis.
  - Demonstrates how to visualize data using scatter plots, line charts, histograms, box plots.
  - Explores expenditure per student across different grade spans.
  - Investigates correlations between expenditure and other variables.
- QQ plots to assess normality and interpret skewness and kurtosis in the data.
  - Given a QQ plot, you should be able to identify how does the distribution compare to normal: positively skewed, negatively skewed, has fat tails, or thin tails.
:::

## Data Visualization with `CASchools`

Data visualization is a powerful tool for understanding patterns, relationships, and distributions in datasets. In this session, we will explore the California Schools dataset using various visualization techniques including histograms, box plots, scatter plots, and Q-Q plots. These visualizations help us answer important questions about educational spending, student performance, and the relationships between various school characteristics.

### Dataset Overview

The following prints the first and last 5 rows of the dataset, together with data types of each column: 

```{r set-up}
# load packages and dataset
pkgs <- c("tidyverse", "moments", "data.table", "ggsci")
missing <- setdiff(pkgs, rownames(installed.packages()))
if (length(missing) > 0) install.packages(missing)
invisible(lapply(pkgs, function(pkg) suppressPackageStartupMessages(library(pkg, character.only = TRUE))))
f_name <- "https://raw.githubusercontent.com/my1396/FIN5005-Fall2025/refs/heads/main/data/CASchools_test_score.csv"
cas <- read_csv(f_name, 
  col_types = cols(
    county = col_factor(), # read as factor
    grades = col_factor()
  ))
```


The following prints the first and last 5 rows of the dataset, together with data types of each column: 

```{r}
cas %>% as.data.table()
```

The [`cas`](https://www.rdocumentation.org/packages/AER/versions/1.2-15/topics/CASchools) dataset contains information on 420 public school districts in California, specifically those that operate either kindergarten through 6th grade (K–6) or kindergarten through 8th grade (K–8) schools, with data collected for the years 1998 and 1999.

The dataset includes:

- **Student performance measures** (average reading and math scores).
- **School characteristics** (such as enrollment, number of teachers, student–teacher ratio, number of computers, expenditure per student).
- **Student demographics** (including income, percentage qualifying for reduced-price lunch, percentage of English learners, etc.).

`cas` is a data frame containing 420 observations on 14 variables. Refer to the following table for the full definition.

| Variable      | Description                                                  |
| ------------- | ------------------------------------------------------------ |
| `district`    | Character. District code. Unique ID.                         |
| `school`      | Character. School name.                                      |
| `county`      | Factor indicating county.                                    |
| `grades`      | Factor indicating grade span covered by the district’s schools. <br />It takes on two values: <br />- `KK-06`: means the district’s schools serve kindergarten through 6th grade.<br />- `KK-08`: means the district’s schools serve kindergarten through 6th grade. |
| `students`    | Total enrollment.                                            |
| `teachers`    | Number of teachers.                                          |
| `calworks`    | Percent qualifying for CalWorks (income assistance program). |
| `lunch`       | Percent qualifying for reduced-price lunch.                  |
| `computer`    | Number of computers.                                         |
| `expenditure` | Expenditure per student.                                     |
| `income`      | District average income (in USD 1,000).                      |
| `english`     | Percent of English learners <br />(i.e., students for whom English is a second language). |
| `read`        | Average reading score.                                       |
| `math`        | Average math score.                                          |

Data source: Stock, J. H. and Watson, M. W. (2020). [Introduction to Econometrics](https://www.sea-stat.com/wp-content/uploads/2020/08/James-H.-Stock-Mark-W.-Watson-Introduction-to-Econometrics-Global-Edition-Pearson-Education-Limited-2020.pdf), 4th ed. Pearson.

--------------------------------------------------------------------------------

### Summary Statistics

The following displays the summary for each variable in the dataset:

```{r}
summary(cas)
```

**Interpreting the Summary Statistics**

This summary provides key insights into our dataset:

- **Continuous variables** (students, teachers, expenditure, income, etc.) show their distribution through quartiles, mean, and range
- **Categorical variables** (county, grades) show frequency counts
- Notice the **range of expenditure** per student: from around \\$3,900 to over \\$7,700 - this substantial variation will be a key focus of our analysis
- **Test scores** (reading and math) also show considerable variation, suggesting potential relationships with school resources

### Expenditure Variation Analysis

Q: To what extent does expenditure per student vary?  

Understanding the distribution of expenditure per student is crucial for education policy analysis. Let's examine detailed descriptive statistics:

```{r}
quick_summary <- function(x, full=FALSE) {
    # Function to compute basic descriptive statistics
    if (!full){
        # Basic summary
        data.frame(
          n = length(x),
          min = min(x),
          mean = mean(x),
          median = median(x),
          max = max(x),
          sd = sd(x),
          skewness = moments::skewness(x),
          kurtosis = moments::kurtosis(x),
          row.names = NULL
        )
    } else {
        # Full summary with quartiles and IQR
        data.frame(
          n = length(x),
          min = min(x),
          Q1 = quantile(x, 0.25),
          mean = mean(x),
          median = median(x),
          Q3 = quantile(x, 0.75),
          max = max(x),
          IQR = IQR(x),
          sd = sd(x),
          skewness = moments::skewness(x),
          kurtosis = moments::kurtosis(x),
          row.names = NULL
        )
    }
}
quick_summary(cas$expenditure) %>% round(2)
```

**Interpreting the Results:**

- **Range:** Expenditure varies from about \\$3,926 to \\$7,712 per student - a difference of nearly \\$4,000
- **Central Tendency:** The mean (\\$5,312) is slightly higher than the median (\\$5,196), **suggesting a slight right skew**
- **Variability:** Standard deviation of \\$633 indicates moderate spread around the mean
- **Skewness (1.07):** Positive skewness confirms some districts spend considerably more than average
- **Kurtosis (4.88):** Larger than 3 indicates a distribution with fat tails relative to the normal distribution.


```{r fig.width=6, fig.asp=0.6}
# Basic histogram
ggplot(cas, aes(x = expenditure)) +
  geom_histogram(binwidth = 500, boundary = 0, fill = "lightblue", color = "black") +
  labs(title = "Histogram of Expenditure per Student",
       x = "Expenditure per Student (USD)",
       y = "Frequency") +
  theme_minimal(base_size = 14)
```

**What the Histogram Reveals:**

- Most districts cluster around the \\$5,000-\\$5,500 range
- Variability is moderate
- The distribution has a long right tail, indicating positive skewness. That suggests that expenditure per student is concentrated at lower values for most districts, while a smaller number of districts spend substantially more, pulling the mean above the median
- There are **few extreme positive outliers**, indicating some districts do spend significantly more than average


--------------------------------------------------------------------------------

### Group Comparison: K-6 vs K-8 Schools

Q: Are there any differences in expenditure per student between K-6 and K-8 schools?

This comparison helps us understand whether grade span affects resource allocation. Let's examine the statistics for each group:

```{r}
cas %>%
    group_by(grades) %>%
    group_map(~ {
        s <- quick_summary(.x$expenditure, full=TRUE)
        s <- cbind(
            grades = .y$grades,    # add group info
            s)
        return(s)
    }) %>%
    bind_rows()
```

**Key Findings:**

- **K–6 schools** (61 districts): Mean expenditure of \\$5,577, slightly higher than K–8 schools
- **K–8 schools** (359 districts): Mean expenditure of \\$5,267, with a larger sample size
- K–6 schools indicating higher variability, with a standard deviation of \\$662 compared to \\$618 for K-8 schools
- **Skewness** is positive for both groups, with K--8 schools showing slightly more skewness
- The difference suggests that **smaller grade span districts may have slightly higher per-pupil spending**

Box plot by grades

```{r hist, fig.asp=1.2, out.width="50%"}
ggplot(cas, aes(x = grades, y = expenditure, fill = grades)) +
  geom_boxplot() +
  scale_fill_npg() +
  labs(x = "Grade Span",
       y = "Expenditure per Student (USD)") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

Understanding the Box Plot:

1. **Box and middle bar (median)**

   -   The **box** itself spans from the **first quartile (Q1, 25th percentile)** to the **third quartile (Q3, 75th percentile)**.

   -   This range is called the **interquartile range (IQR = Q3 - Q1)**.

   -   The **middle bar** inside the box represents the **median (50th percentile)**.

       -   If the median is closer to the bottom of the box, the lower half of the data is more concentrated.

       -   If closer to the top, the upper half is more concentrated. 

2. **Whiskers**

   -   The **whiskers** extend from the box to show the range of the data **excluding outliers**.

   -   A whisker extends to the **largest/smallest value within 1.5 × IQR from the box**:

       -   Upper whisker = largest value ≤ Q3 + 1.5 × IQR

       -   Lower whisker = smallest value ≥ Q1 - 1.5 × IQR

3. **Outliers**

   -   **Points beyond the whiskers** are plotted individually as **outliers**.

   -   These are values that are unusually high or low relative to the bulk of the data.

::: {.callout-tip appearance="simple"}
**Summary of boxplot**

- Box: middle 50% of the data
- Middle line: median
- Whiskers: typical range, excluding extreme values
- Outliers: extreme observations
:::

--------------------------------------------------------------------------------

**Interpreting the Box Plot:**

- **Median lines:** K--6 districts show a higher median expenditure than K-8 districts
- **Box sizes:** K--6 district show a larger interquartile ranges (IQR), indicating greater middle 50% spread
- **Outliers:** K--8 groups show more positive outliers (points beyond the whiskers), representing districts with unusually high expenditure



--------------------------------------------------------------------------------

### Correlation Analysis

**Q: What predicts expenditure per student?**

Understanding which factors correlate with expenditure helps identify patterns in educational resource allocation. Let's examine correlations:

Correlation coefficients in ascending order:

```{r}
# Get the set of numeric variables
v <- setdiff(
    names(cas),
    c("district", "school", "county", "grades")
)
corExp <- cor(cas["expenditure"], cas[setdiff(v, "expenditure")])
t(corExp) %>%
    as.data.frame() %>%
    rownames_to_column(var = "variable") %>%
    rename(correlation = expenditure) %>% 
    arrange(correlation)
```

**Key Correlation Insights:**

- No strong correlations (e.g., $>|0.7|$) with expenditure
- **Positive correlations:** Income (0.31), math scores (0.22), and reading scores (0.15)
- **Moderate Negative correlations:** Students($-0.11$), indicating districts with a larger amount of students tend to spend less per student
- **Interpretation:** 
  - Wealthier districts tend to spend more per student
  - Higher spending correlates with better test scores
  - Districts with more students may face budget constraints leading to lower per-student expenditure



Plot scatter plots for the top three correlated variables

```{r fig.width=12, fig.asp=0.3}
top_vars <- c("income", "math", "read")
cas_long <- cas %>%
    select(expenditure, all_of(top_vars)) %>%
    pivot_longer(cols = all_of(top_vars), names_to = "variable", values_to = "value")
ggplot(cas_long, aes(x = value, y = expenditure)) +
    geom_point(alpha = 0.6, color = "#1976d2") +
    facet_wrap(~variable, scales = "free_x") +
    labs(
        title = "Scatter Plots of Expenditure per Student vs. Top Correlated Variables",
        x = "Value",
        y = "Expenditure per Student (USD)"
    ) +
    theme_minimal(base_size = 14)   
```

**What These Scatter Plots Reveal:**

- **Income vs. Expenditure:** Positive relationship - wealthier districts consistently spend more per student; the trend is relatively clear with some variability;
- **Math Scores vs. Expenditure:** Positive trend suggests higher spending correlates with better math performance; the points are more scattered, indicating other factors also play a role;
- **Reading Scores vs. Expenditure:** Similar pattern to math scores, showing the relationship between resources and achievement
- **Data Distribution:** Points are fairly scattered, indicating that while correlations exist, other factors also influence these relationships


--------------------------------------------------------------------------------

### Academic Performance Relationship

Q: what is the relationship between district level maths and reading scores?

Academic performance across different subjects often correlates, as they reflect overall educational quality and student preparation. Let's examine this relationship:

```{r fig.width=6, fig.asp=0.6, message=FALSE}
ggplot(cas, aes(x = read, y = math)) +
    geom_point(alpha = 0.6, color = "#1976d2") +
    geom_smooth(method = "lm", color = "#d32f2f") +
    labs(
        title = "Scatter Plot of Math vs. Reading Scores",
        x = "Average Reading Score",
        y = "Average Math Score"
    ) +
    theme_minimal(base_size = 14)
```

**Analysis of the Relationship:**

- **Strong positive correlation:** Districts with higher reading scores typically have higher math scores
- **Linear trend:** The smooth line shows a clear linear relationship between the two subjects
- **Tight clustering:** Most points cluster closely around the trend line, indicating a strong relationship
- **Educational insights:** 
  - This suggests that factors affecting academic performance impact multiple subjects similarly
  - Districts that excel in one area tend to excel in others


--------------------------------------------------------------------------------

## Q-Q Plot

The <span class="env-green">Q-Q plot</span>, or <span class="env-green">quantile-quantile plot</span>, is a graphical tool to help us assess if a set of data plausibly came from some theoretical distribution such as a normal distribution. 

**Understanding Q-Q Plots:**

A QQ plot is a scatter plot created by plotting two sets of quantiles against one another. 

- If both sets of quantiles came from the same distribution, we should see the points forming a line that's roughly straight. 

- For example, if we run a statistical analysis that assumes our **residuals** are normally distributed, we can use a <span class="env-green">normal QQ plot</span> to check that assumption. 
  
  When the theoretical quantiles are from a normal distribution, the plot is called a **normal QQ plot**.

**Why Q-Q Plots Matter:**

- Many statistical tests assume normality; deviations from normality can affect the validity of statistical inferences
- Q-Q plots provide a visual method to assess these assumptions
- They help identify the type of non-normality (skewness, heavy tails, etc.)


### QQ plot visualization tool 

<https://xiongge.shinyapps.io/QQplots/>

Adjust Skewness and Kurtosis to see how the QQ plot changes.

--------------------------------------------------------------------------------

### Skewness

#### Positive skew

Positively skewed (mean > median) data have a J-shaped pattern in the Q-Q plot.

```{r echo = FALSE, message=FALSE}
library(fGarch)
sim_data <- rsnorm(10000, mean = 0, sd = 1, xi = 2.5)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot() +
    geom_histogram(aes(x=sim_data, 
                       y=..density..),
                   fill="#BDBCBC", 
                   color="black", 
                   binwidth = .2, 
                   boundary=0) +
    geom_density(aes(x=sim_data), color="black") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), color="blue") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), fill="blue", geom="area", alpha=0.2) +
    labs(x="Sample values", y="Density", title="Density plot") +
    scale_x_continuous(limits = c(-4,4))
```

```{r echo=FALSE}
ggplot() +
    geom_qq(aes(sample=sim_data)) +
    geom_qq_line(aes(sample=sim_data), color="red") +
    labs(x="Theoretical quantiles", y="Sample quantiles", 
         title="Normal Q-Q plot")
```

Summary statistics:

```{r echo=FALSE}
quick_summary(sim_data) %>% round(2)
```

💡 Note that for a positive skewed distribution, **the median is larger than the mean** because the long right tail pulls the mean above the median.

**Understanding Positive Skewness:**

- **Shape:** Long tail extending to the right
- **Mean vs. Median:** Mean > Median (tail pulls the mean upward)
- **Q-Q Plot Pattern:** J-shaped curve, points above the line at higher quantiles
- **Real-world examples:** Income distribution, housing prices
- **Statistical implications:** May indicate floor effects or bounded distributions


#### Negative skew

Negatively skewed (mean < median) data have Q-Q plots that display an inverted J-shape.

```{r echo = FALSE}
sim_data <- rsnorm(10000, mean = 0, sd = 1, xi = -2.5)
```


```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot() +
    geom_histogram(aes(x=sim_data, 
                       y=..density..),
                   fill="#BDBCBC", 
                   color="black", 
                   binwidth = .2, 
                   boundary=0) +
    geom_density(aes(x=sim_data), color="black") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), color="blue") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), fill="blue", geom="area", alpha=0.2) +
    labs(x="Sample values", y="Density", title="Density plot") +
    scale_x_continuous(limits = c(-4,4))

```

```{r echo = FALSE}
ggplot() +
    geom_qq(aes(sample=sim_data)) +
    geom_qq_line(aes(sample=sim_data), color="red") +
    labs(x="Theoretical quantiles", y="Sample quantiles", 
         title="Normal Q-Q plot")
```

Summary statistics:

```{r echo=FALSE}
quick_summary(sim_data) %>% round(2)
```

💡 Note that for a negatively skewed distribution, **the median is smaller than the mean** because the long left tail pulls the mean above the median.

**Understanding Negative Skewness:**

- **Shape:** Long tail extending to the left
- **Mean vs. Median:** Mean < Median (tail pulls the mean downward)
- **Q-Q Plot Pattern:** Inverted J-shaped curve, points below the line at lower quantiles
- **Real-world examples:** Test scores (when most students perform well), age at retirement
- **Statistical implications:** May indicate ceiling effects or bounded distributions

### Kurtosis

Kurtosis measures the "tailedness" of a distribution compared to a normal distribution. Understanding kurtosis helps identify distributions with unusually many or few extreme values.

#### Fat tails

This plot shows a t-distribution with $3$ degrees of freedom, which has heavier tails than a normal distribution.
```{r echo = FALSE}
sim_data <-  rt(n=1000, df=3)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot() +
    geom_histogram(aes(x=sim_data, 
                       y=..density..),
                   fill="#BDBCBC", 
                   color="black", 
                   binwidth = .2, 
                   boundary=0) +
    geom_density(aes(x=sim_data), color="black") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), color="blue") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), fill="blue", geom="area", alpha=0.2) +
    labs(x="Sample values", y="Density", title="Density plot") +
    scale_x_continuous(limits = c(-4,4))

```

```{r echo = FALSE}
ggplot() +
    geom_qq(aes(sample=sim_data)) +
    geom_qq_line(aes(sample=sim_data), color="red") +
    labs(x="Theoretical quantiles", y="Sample quantiles", 
         title="Normal Q-Q plot")
```

Summary statistics:

```{r echo=FALSE}
quick_summary(sim_data) %>% round(2)
```

**Understanding Fat Tails (High Kurtosis):**

- **Q-Q Plot Pattern:** S-shaped curve - points below the line at both extremes, above in the middle
- **Kurtosis > 3:** Indicates heavier tails than normal distribution
- **Practical meaning:** More extreme values (both high and low) occur than expected under normality
- **Real-world examples:** 
  - **Financial returns:** Stock market crashes and booms occur more frequently than normal distribution predicts
  - **Measurement errors:** Occasionally very large errors occur due to equipment malfunction or human mistakes
  - **Response times:** Most responses are quick, but some take much longer due to system overload or user distraction
- **Statistical implications:** Higher risk of extreme events; standard confidence intervals may be too narrow

#### Thin tails

This example shows a distribution with lighter tails than normal.

```{r  echo = FALSE}
sim_data <-  rnorm(n=1000, mean=0, sd=0.1) + runif(1000, -1, 1)
```

```{r echo = FALSE, message=FALSE}
ggplot() +
    geom_histogram(
        aes(x=sim_data, 
            y=..density..),
        fill="#BDBCBC", 
        color="black", 
        binwidth = .2, 
        boundary=0) +
    geom_density(aes(x=sim_data), color="black") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), color="blue") +
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1), fill="blue", geom="area", alpha=0.2) +
    labs(x="Sample values", y="Density", title="Density plot") +
    scale_x_continuous(limits = c(-4,4))
```

```{r echo = FALSE}
ggplot() +
    geom_qq(aes(sample=sim_data)) +
    geom_qq_line(aes(sample=sim_data), color="red") +
    labs(x="Theoretical quantiles", y="Sample quantiles", 
         title="Normal Q-Q plot")
```


Summary statistics:

```{r echo=FALSE}
quick_summary(sim_data) %>% round(2)
```

**Understanding Thin Tails (Low Kurtosis):**

- **Q-Q Plot Pattern:** Reverse S-shaped curve - points above the line at extremes, below in the middle
- **Kurtosis < 3:** Indicates lighter tails than normal distribution
- **Practical meaning:** Fewer extreme values occur than expected under normality
- **Real-world examples:** Bounded measurements, standardized test scores, some quality control data
- **Statistical implications:** Lower risk of extreme events; data more predictable than normal assumption suggests

--------------------------------------------------------------------------------

**Summary of Distribution Shapes**

Understanding these patterns helps in:

- **Choosing appropriate statistical methods**
- **Identifying data quality issues**
- **Making informed assumptions about uncertainty**
- **Selecting proper transformations when needed**
- **Interpreting results correctly in context**